<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinical Summary ‚Äî Doc</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --accent:#2563eb;
      --accent2:#16a34a;
      --soft:#eff6ff;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background: radial-gradient(1200px 800px at 20% 0%, #eef2ff 0%, transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, #ecfeff 0%, transparent 55%),
                  var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{width:min(920px, 100%);}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid var(--line); border-radius:999px;
      background:rgba(255,255,255,.65); backdrop-filter: blur(8px);
    }
    .dot{
      width:10px; height:10px; border-radius:999px; background:var(--accent2);
      box-shadow:0 0 0 4px rgba(22,163,74,.12);
    }
    .brand b{font-size:14px}
    .brand span{font-size:12px; color:var(--muted)}
    .meta{
      font-family:var(--mono);
      font-size:12px; color:var(--muted);
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.65);
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }

    .card{
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .header{
      padding:18px 18px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(239,246,255,.85), rgba(255,255,255,.75));
    }
    .header h1{
      margin:0; font-size:18px; letter-spacing:.2px;
    }
    .sub{
      margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:var(--soft);
      border:1px solid #dbeafe;
      font-size:12px; color:#1e40af;
      font-family:var(--mono);
    }

    .progress{
      height:8px; background:#eef2ff; border-radius:999px; overflow:hidden;
      margin-top:12px;
      border:1px solid #e0e7ff;
    }
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #60a5fa);}
    .content{padding:18px;}
    .page{display:none; animation:fade .22s ease;}
    .page.active{display:block;}
    @keyframes fade{from{opacity:.6; transform:translateY(4px)} to{opacity:1; transform:none}}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} .meta{display:none;} }

    .panel{
      border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      border-radius:14px;
      padding:14px;
    }
    .panel h2{margin:0 0 8px; font-size:14px;}
    .panel p{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}

    .formrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
    input{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:white;
      font-size:14px;
      outline:none;
    }
    input:focus{border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.14);}

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}
    button{
      border:none;
      padding:11px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .primary{background:var(--accent); color:white;}
    .primary:hover{filter:brightness(.98)}
    .ghost{
      background:transparent;
      border:1px solid var(--line);
      color:var(--ink);
    }
    .ghost:hover{background:rgba(255,255,255,.7)}
    .choice{
      width:100%;
      text-align:left;
      background:white;
      border:1px solid var(--line);
      color:var(--ink);
      padding:12px 12px;
      border-radius:14px;
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .choice:hover{border-color:#93c5fd; box-shadow:0 10px 22px rgba(37,99,235,.08)}
    .choice .k{
      font-family:var(--mono);
      font-size:12px;
      color:#1e40af;
      background:var(--soft);
      border:1px solid #dbeafe;
      padding:3px 8px;
      border-radius:999px;
      margin-top:2px;
      white-space:nowrap;
    }
    .choice .t b{display:block; font-size:14px;}
    .choice .t span{display:block; margin-top:2px; color:var(--muted); font-size:12px; line-height:1.4}

    .note{
      font-family:var(--mono);
      font-size:12px;
      color:#0f172a;
      background:#0b1220;
      color:#e5e7eb;
      border-radius:14px;
      padding:14px;
      line-height:1.55;
      border:1px solid rgba(148,163,184,.25);
      overflow:auto;
    }
    .note .dim{color:#93c5fd}
    .note .ok{color:#86efac}
    .note .warn{color:#fde68a}

    .final{
      text-align:center;
      padding:10px 6px 2px;
    }
    .big{
      font-size:36px;
      letter-spacing:.4px;
      margin:8px 0 6px;
    }
    .heartline{
      height:46px;
      margin:10px auto 0;
      width:min(520px, 100%);
      opacity:.9;
    }
    .small{
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
      text-align:left;
      max-width:720px;
      margin:14px auto 0;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.85);
    }
    .sig{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:14px; color:var(--muted); font-size:12px; font-family:var(--mono);
    }
    .ring{
      display:inline-flex; align-items:center; justify-content:center;
      width:34px; height:34px; border-radius:999px;
      background:rgba(37,99,235,.12);
      border:1px solid rgba(37,99,235,.25);
      margin:0 auto;
    }
    .footer{
      padding:14px 18px;
      border-top:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      background:rgba(255,255,255,.7);
    }
    .footleft{color:var(--muted); font-size:12px}
    .footleft b{color:var(--ink)}
    .mute{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
    }
  
    /* Celebration page */
    .celebrateWrap{
      position: relative;
      overflow:hidden;
      border-radius:18px;
      border:1px solid var(--line);
      background: radial-gradient(900px 500px at 20% 0%, rgba(59,130,246,.20), transparent 60%),
                  radial-gradient(800px 520px at 90% 20%, rgba(236,72,153,.18), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.75));
      box-shadow: var(--shadow);
      padding: 18px;
      min-height: 420px;
    }
    #confettiCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }
    .dreamy{
      position:relative;
      z-index:2;
      text-align:center;
      padding: 16px 10px 8px;
    }
    .dreamy .big2{
      font-size:38px;
      margin:10px 0 8px;
      letter-spacing:.4px;
    }
    .dreamy p{
      margin:0 auto;
      color:var(--muted);
      max-width:720px;
      font-size:14px;
      line-height:1.7;
    }
    .floatingHearts span{
      position:absolute;
      bottom:-40px;
      font-size:18px;
      opacity:.75;
      animation: floatUp 7s linear infinite;
      filter: drop-shadow(0 10px 18px rgba(15,23,42,.10));
      pointer-events:none;
    }
    @keyframes floatUp{
      from{transform:translateY(0) translateX(0); opacity:.0}
      10%{opacity:.75}
      to{transform:translateY(-520px) translateX(-40px); opacity:0}
    }

    /* Valentine overlay */
    .valentineOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      background: radial-gradient(900px 600px at 20% 0%, rgba(236,72,153,.25), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(59,130,246,.18), transparent 55%),
                  rgba(15,23,42,.35);
      z-index:999;
      backdrop-filter: blur(6px);
    }
    .valentineOverlay.show{display:flex; animation:fade .22s ease;}
    .valentineCard{
      width:min(760px, 100%);
      border-radius:20px;
      padding:22px 22px 18px;
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.86));
      border:1px solid rgba(236,72,153,.25);
      box-shadow:0 30px 60px rgba(15,23,42,.18);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .valentineGlow{
      position:absolute;
      inset:auto -20% -30% -20%;
      height:200px;
      background:radial-gradient(closest-side, rgba(236,72,153,.25), transparent 70%);
      pointer-events:none;
    }
    .valentineTitle{
      font-size:34px;
      margin:6px 0 8px;
      letter-spacing:.4px;
    }
    .valentineSub{
      margin:0 auto;
      color:var(--muted);
      max-width:600px;
      font-size:14px;
      line-height:1.7;
    }
    .valentineBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(236,72,153,.35);
      background:rgba(236,72,153,.12);
      font-size:12px;
      font-family:var(--mono);
      color:#9f1239;
    }
    .valentineBtns{display:flex; justify-content:center; gap:10px; margin-top:16px; flex-wrap:wrap;}
    .valentinePrimary{
      background:linear-gradient(90deg, #ec4899, #f43f5e);
      color:white;
      border:none;
      padding:11px 16px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
    }
    .valentineGhost{
      background:transparent;
      border:1px solid rgba(15,23,42,.12);
      color:var(--ink);
      padding:11px 16px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
    }
    .valentineHearts span{
      position:absolute;
      bottom:-30px;
      font-size:18px;
      opacity:.7;
      animation: floatUp 6.5s linear infinite;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="valentineOverlay" id="valentineOverlay" aria-hidden="true">
    <div class="valentineCard">
      <div class="valentineGlow"></div>
      <div class="valentineBadge">üéÇ Birthday Edition</div>
      <div class="valentineTitle">Happy Birthday, <span id="valentineName">DOC</span>!</div>
      <p class="valentineSub">
        Wishing you joy, peace, and many beautiful moments ahead.
      </p>
      <div class="valentineHearts" aria-hidden="true" id="valentineHearts"></div>
      <div class="valentineBtns">
        <button class="valentinePrimary" id="valentineEnter">Enter the note</button>
        <button class="valentineGhost" id="valentineSkip">Skip</button>
      </div>
    </div>
  </div>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <b>Clinical Note</b><br/>
          <span>Doc ‚Ä¢ Private Link</span>
        </div>
      </div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="card">
      <div class="header">
        <h1 id="title">Patient Intake</h1>
        <div class="sub">
          <div class="pill">Case ID: L2000101019990301</div>
          <!-- <div class="pill">Service: Heart & Mind</div> -->
          <div class="pill" id="stepPill">Step 1 / 5</div>
        </div>
        <div class="progress" aria-label="progress">
          <div class="bar" id="bar"></div>
        </div>
      </div>

      <div class="content">
        <!-- Page 1 -->
        <section class="page active" data-title="Patient Intake">
          <div class="grid">
            <div class="panel">
              <h2>Welcome, Doc</h2>
              <p>
                This is a small clinical flow designed with care.
                Please proceed like a case review one step at a time.
              </p>

              <div class="formrow" style="margin-top:14px;">
                <div style="flex:1; min-width:220px;">
                  <label>Patient Name</label>
                  <input id="patient" value="Shiva" />
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>Attending</label>
                  <input id="attending" value="Bhavana(DOC)" />
                </div>
              </div>

              <div class="btns">
                <button class="primary" id="next1">Begin Assessment</button>
              </div>
              <div class="mute" style="margin-top:10px;">
                Tip: Works best on mobile ‚Äî tap through like an app.
              </div>
            </div>

            <div class="panel">
              <h2>Chief Complaint</h2>
              <p>Select the reason for visit:</p>
              <div class="btns" style="margin-top:12px;">
                <button class="choice" data-cc="Unexplained calm + confidence">
                  <span class="k">CC</span>
                  <span class="t">
                    <b>Unexplained calm</b>
                    <span>Confidence and hope appear without warning.</span>
                  </span>
                </button>

                <button class="choice" data-cc="Persistent warmth in the heart">
                  <span class="k">CC</span>
                  <span class="t">
                    <b>Persistent warmth</b>
                    <span>Feels steady‚Ä¶ like home.</span>
                  </span>
                </button>

                <button class="choice" data-cc="A life that feels brighter than before">
                  <span class="k">CC</span>
                  <span class="t">
                    <b>Life feels brighter</b>
                    <span>Oblivion replaced by meaning.</span>
                  </span>
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Page 2 -->
        <section class="page" data-title="History & Assessment">
          <div class="grid">
            <div class="panel">
              <h2>HPI</h2>
              <p>Choose what fits best:</p>

              <div class="btns" style="margin-top:12px;">
                <button class="choice" data-hpi="Onset: gradually, then all at once.">
                  <span class="k">HPI</span>
                  <span class="t">
                    <b>Onset</b>
                    <span>Gradually‚Ä¶ then suddenly undeniable.</span>
                  </span>
                </button>

                <button class="choice" data-hpi="Course: steady, kind, and reassuring.">
                  <span class="k">HPI</span>
                  <span class="t">
                    <b>Course</b>
                    <span>Steady, kind, always grounding.</span>
                  </span>
                </button>

                <button class="choice" data-hpi="Context: you stood with me in good and bad.">
                  <span class="k">HPI</span>
                  <span class="t">
                    <b>Context</b>
                    <span>You stood with me through everything.</span>
                  </span>
                </button>
              </div>

              <div class="btns">
                <button class="ghost" id="back2">Back</button>
                <button class="primary" id="next2">Continue</button>
              </div>
            </div>

            <div class="panel">
              <h2>Vitals (gentle & classy)</h2>
              <p>Objective findings (non-alarming):</p>
              <div class="note" style="margin-top:12px;">
                <span class="dim">HR</span>: elevated in your presence<br/>
                <span class="dim">BP</span>: stable ‚Äî because you bring peace<br/>
                <span class="dim">SpO‚ÇÇ</span>: 100% (breathing gets easier around you)<br/>
                <span class="dim">Mood</span>: improved<br/>
                <span class="dim">Hope</span>: <span class="ok">positive</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Page 3 -->
        <section class="page" data-title="Investigations">
          <div class="grid">
            <div class="panel">
              <h2>Order Investigations</h2>
              <p>Select one (or tap all ‚Äî it‚Äôs allowed here):</p>

              <div class="btns" style="margin-top:12px;">
                <button class="choice" data-test="ECG" data-result="Result: rhythm changes whenever you smile.">
                  <span class="k">TEST</span>
                  <span class="t"><b>ECG</b><span>Check the rhythm.</span></span>
                </button>

                <button class="choice" data-test="CBC" data-result="Result: reasons I adore you, count: immeasurable.">
                  <span class="k">TEST</span>
                  <span class="t"><b>CBC</b><span>Check what‚Äôs within.</span></span>
                </button>

                <button class="choice" data-test="MRI (Meaning Review Imaging)" data-result="Result: confidence and hope: clearly present.">
                  <span class="k">TEST</span>
                  <span class="t"><b>MRI</b><span>Review what life became.</span></span>
                </button>
              </div>

              <div class="btns">
                <button class="ghost" id="back3">Back</button>
                <button class="primary" id="next3">See Diagnosis</button>
              </div>
            </div>

            <div class="panel">
              <h2>Results</h2>
              <p>Tap a test to populate results:</p>
              <div class="note" id="results" style="margin-top:12px;">
                <span class="warn">No tests selected yet.</span><br/>
                Tap any investigation on the left.
              </div>
            </div>
          </div>
        </section>

        <!-- Page 4 -->
        <section class="page" data-title="Diagnosis & Plan">
          <div class="grid">
            <div class="panel">
              <h2>Assessment</h2>
              <div class="note">
                <span class="dim">Impression</span>: you bring values and sensibilities I admire deeply.<br/>
                <span class="dim">Support</span>: you stood with me in all my deeds, good and bad.<br/>
                <span class="dim">Concern</span>: none. Why worry about elsewhere?
              </div>

              <div class="btns">
                <button class="ghost" id="back4">Back</button>
                <button class="primary" id="next4">Discharge Summary</button>
              </div>
            </div>

            <div class="panel">
              <h2>Diagnosis</h2>
              <div class="final">
                <div class="ring">üíô</div>
                <div class="big" style="margin-top:10px;">Love, Confirmed!</div>
                <p style="margin:0; color:var(--muted); font-size:13px;">
                  A beautiful, steady condition - improving daily.
                </p>

                <svg class="heartline" viewBox="0 0 600 80" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="heartbeat line">
                  <path d="M0 45 H120 L145 45 L165 15 L185 70 L205 45 H250
                           C270 45 275 20 290 20 C310 20 315 45 335 45
                           C355 45 360 20 375 20 C395 20 400 45 420 45
                           H600" stroke="rgba(37,99,235,.9)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
          </div>
        </section>

        <!-- Page 5 (Grand) -->
        <section class="page" data-title="Discharge Summary">
          <div class="panel" style="border-radius:18px;">
            <div class="final">
              <div class="ring">ü©∫</div>
              <div class="big" id="loveLine">Happy Birthday, Doc üéâ</div>
              <p style="margin:0; color:var(--muted); font-size:13px;">Discharge Summary ‚Ä¢ Confidential</p>
            </div>

            <div class="small" id="finalText">
              <!-- Filled by JS -->
            </div>

            <div class="sig">
              <div>Signed: <span id="sigName">Me</span></div>
              <div>Date: <span id="sigDate"></span></div>
              <div>Follow-up: Forever</div>
            </div>

            <div class="btns" style="justify-content:center; margin-top:16px;">
              <button class="ghost" id="restart">Restart</button>
              <button class="primary" id="yesBtn">‚ù§Ô∏è Yes, I will</button>
              <button class="ghost" id="noBtn">Sorry, I can't</button>
            </div>

            <div id="afterYes" style="display:none; margin-top:16px;"></div>
          </div>
        </section>

        <!-- Page 6 (Celebration) -->
        <section class="page" data-title="Celebration">
          <div id="celebrateMount"></div>
        </section>
      </div>

      <div class="footer">
        <div class="footleft">
          <b id="footerPatient">Provider:</b> <span id="footerPatientName">Doc</span> &nbsp;‚Ä¢&nbsp;
          <span class="mute">Tap through like a case review.</span>
        </div>
        <div class="mute" id="footerCC">CC: ‚Äî</div>
      </div>
    </div>
  </div>

<script>
  // ----- State -----
  let confettiRaf = null;
  let confettiTimer = null;
  let dischargeNotified = false;
  let openedNotified = false;

  const state = {
    patient: "Doc",
    attending: "Shiva",
    cc: null,
    hpi: null,
    tests: []
  };

  // ----- Helpers -----
  const $ = (q) => document.querySelector(q);
  const $$ = (q) => Array.from(document.querySelectorAll(q));

  const pages = $$(".page");
  let step = 0; // 0..4

  function setMeta(){
    const now = new Date();
    $("#meta").textContent =
      `Session: ${now.toLocaleString([], {year:'numeric', month:'short', day:'2-digit'})} ‚Ä¢ ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    $("#sigDate").textContent = now.toLocaleDateString([], {year:'numeric', month:'long', day:'numeric'});
  }

  function showStep(n){
    step = Math.max(0, Math.min(pages.length-1, n));
    pages.forEach((p,i)=>p.classList.toggle("active", i===step));

    const title = pages[step].dataset.title || "Clinical Note";
    $("#title").textContent = title;

    $("#stepPill").textContent = `Step ${step+1} / ${pages.length}`;
    $("#bar").style.width = `${((step+1)/pages.length)*100}%`;

    // Footer
    $("#footerPatientName").textContent = state.patient || "Doc";
    $("#footerCC").textContent = `CC: ${state.cc ?? "‚Äî"}`;

    // Update final
    $("#sigName").textContent = state.attending || "Me";
    $("#loveLine").textContent = `Happy Birthday, ${state.patient || "Doc"}!`;
    $("#finalText").innerHTML = `
  <div style="font-size:14px; line-height:1.75;">
    <div style="margin-bottom:12px;"><b>Birthday Note:</b></div>

    <div style="margin-bottom:12px;">
      Happy Birthday, ${state.patient || "Doc"}.
      May the days ahead and the years to come be filled with happiness, good things, and moments that bring you real peace.
    </div>

    <div style="margin-bottom:12px;">
      I hope your dreams grow stronger with time and that life gives you every chance to turn them into reality.
    </div>

    <div style="margin-bottom:12px;">
      May this new year of your life bring good happenings, kind people, meaningful memories, and many reasons to smile.
    </div>

    <div style="margin-bottom:12px;">
      You deserve a beautiful journey ahead, and I truly hope this year brings you closer to everything your heart wishes for.
    </div>

    <div><b>Happy Birthday once again, ${state.patient || "Doc"}.</b></div>
  </div>
`;

    // Celebration trigger
    if (pages[step] && pages[step].dataset.title === "Celebration") {
      renderCelebration();
      startCelebration();
    } else {
      stopCelebration();
    }

  }

  function addResultLine(line){
    const box = $("#results");
    if (box.dataset.empty === "true" || box.textContent.includes("No tests selected yet")) {
      box.textContent = "";
      box.dataset.empty = "false";
    }
    const div = document.createElement("div");
    div.textContent = line;
    box.appendChild(div);
  }

  // ----- Events -----
  setMeta();

  // Page 1 inputs
  $("#patient").addEventListener("input", (e)=>{
    state.patient = e.target.value.trim() || "Doc";
    $("#footerPatientName").textContent = state.patient;
    const vName = document.getElementById("valentineName");
    if (vName) vName.textContent = state.patient.toUpperCase();
  });
  $("#attending").addEventListener("input", (e)=>{
    state.attending = e.target.value.trim() || "Me";
  });

  // Chief complaint choices
  $$("button[data-cc]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.cc = btn.dataset.cc;
      $("#footerCC").textContent = `CC: ${state.cc}`;
      // Subtle selection feedback
      $$("button[data-cc]").forEach(b=>b.style.borderColor = "var(--line)");
      btn.style.borderColor = "#93c5fd";
    });
  });

  // HPI choices
  $$("button[data-hpi]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.hpi = btn.dataset.hpi;
      $$("button[data-hpi]").forEach(b=>b.style.borderColor = "var(--line)");
      btn.style.borderColor = "#93c5fd";
    });
  });

  // Tests
  $$("button[data-test]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const t = btn.dataset.test;
      const r = btn.dataset.result;

      // allow multiple but avoid duplicates
      if (!state.tests.includes(t)) state.tests.push(t);

      $("#results").innerHTML = state.tests.map(x=>{
        const found = $$("button[data-test]").find(b=>b.dataset.test===x);
        return `‚Ä¢ ${x}: ${found ? found.dataset.result.replace("Result: ","") : ""}`;
      }).join("<br/>");

      // selection styling
      btn.style.borderColor = "#93c5fd";
    });
  });

  // Navigation
  $("#next1").addEventListener("click", ()=>{
    // If CC not selected, pick the nicest default (still classy)
    if (!state.cc) state.cc = "A life that feels brighter than before";
    showStep(1);
  });

  $("#back2").addEventListener("click", ()=>showStep(0));
  $("#next2").addEventListener("click", ()=>{
    if (!state.hpi) state.hpi = "Context: you stood with me ‚Äî in good and bad.";
    showStep(2);
  });

  $("#back3").addEventListener("click", ()=>showStep(1));
  $("#next3").addEventListener("click", ()=>showStep(3));

  $("#back4").addEventListener("click", ()=>showStep(2));
  $("#next4").addEventListener("click", async ()=>{
    showStep(4);
    if (!dischargeNotified){
      dischargeNotified = true;
      const msg =
`üìÑ <b>Opened:</b> Discharge Summary
<b>Patient:</b> ${state.patient || "Doc"}
<b>CC:</b> ${state.cc || "‚Äî"}
<b>Time:</b> ${new Date().toLocaleString()}`;
      await sendTelegramNotification(msg);
    }
  });

  $("#restart").addEventListener("click", ()=>{
    // keep her name + attending, reset rest
    state.cc = null; state.hpi = null; state.tests = [];
    dischargeNotified = false;
    $("#results").innerHTML = `<span class="warn">No tests selected yet.</span><br/>Tap any investigation on the left.`;
    $$("button[data-cc], button[data-hpi], button[data-test]").forEach(b=>b.style.borderColor="var(--line)");
    $("#afterYes").style.display = "none";
    const y=document.getElementById("yesBtn");
    const n=document.getElementById("noBtn");
    if (y && n){ y.disabled=false; n.disabled=false; y.style.opacity=1; n.style.opacity=1; }
    showStep(0);
  });

  async function notifyOpened(){
    if (openedNotified) return;
    openedNotified = true;
    const msg =
`üéÇ <b>Opened:</b> Happy Birthday, DOC!
<b>Patient:</b> ${state.patient || "Doc"}
<b>Time:</b> ${new Date().toLocaleString()}`;
    await sendTelegramNotification(msg);
  }

  function openValentineOverlay(){
    const overlay = document.getElementById("valentineOverlay");
    const hearts = document.getElementById("valentineHearts");
    const vName = document.getElementById("valentineName");
    if (vName) vName.textContent = (state.patient || "DOC").toUpperCase();
    if (!overlay) return;
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden", "false");
    if (hearts){
      hearts.innerHTML = "";
      const icons = ["üíó","üíû","üíñ","üíù","‚ú®"];
      for (let i=0;i<12;i++){
        const s = document.createElement("span");
        s.textContent = icons[i % icons.length];
        s.style.left = Math.round(Math.random()*100) + "%";
        s.style.animationDelay = (Math.random()*2) + "s";
        s.style.animationDuration = (6 + Math.random()*3) + "s";
        s.style.fontSize = (14 + Math.random()*14) + "px";
        hearts.appendChild(s);
      }
    }
  }

  function closeValentineOverlay(){
    const overlay = document.getElementById("valentineOverlay");
    if (!overlay) return;
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden", "true");
  }

  // --- Telegram notification (GitHub Pages friendly) ---
// 1) Create a bot via @BotFather and paste the token below.
// 2) Get your chat id via @userinfobot and paste below.
// NOTE: These values are visible in page source. Anyone who views the site can see them.
// If you ever get spam, regenerate the token in @BotFather.
const TELEGRAM_BOT_TOKEN = "8283338978:AAFh0GOYmepgFMGoQHCbcDPZsKPJVOZPzyg";
const TELEGRAM_CHAT_ID = "5329985568";

async function sendTelegramNotification(message){
  if (!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.includes("PASTE_")) return false;
  if (!TELEGRAM_CHAT_ID || TELEGRAM_CHAT_ID.includes("PASTE_")) return false;

  const base = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  const payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: message,
    parse_mode: "HTML",
    disable_web_page_preview: true
  };

  // Primary attempt: normal POST so we can read errors (works when CORS allows).
  try{
    const res = await fetch(base, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (res.ok) return true;
    const errText = await res.text().catch(()=> "");
    console.error("Telegram error", res.status, errText);
  }catch(err){
    console.warn("Telegram POST blocked, falling back to no-cors", err);
  }

  // Fallback: no-cors GET so the request still reaches Telegram from file:// or static hosting.
  try{
    const qs = new URLSearchParams(payload);
    await fetch(`${base}?${qs.toString()}`, { method: "GET", mode: "no-cors" });
    return true; // cannot read response in no-cors mode
  }catch(e){
    console.error("Telegram fallback failed", e);
    return false;
  }
}

// ----- Celebration (confetti + dreamy hearts) -----
let confettiAnimId = null;

function renderCelebration(){
  const mount = document.getElementById("celebrateMount");
  if (!mount) return;
  // If already rendered, do nothing
  if (mount.dataset.rendered === "true") return;

  mount.innerHTML = `
    <div class="celebrateWrap">
      <canvas id="confettiCanvas" aria-hidden="true"></canvas>
      <div class="floatingHearts" aria-hidden="true" id="floatingHearts"></div>

      <div class="dreamy">
        <div class="ring">‚ú®</div>
        <div class="big2">Thank you, ${state.patient || "Doc"} üíô</div>
        <p>
          You just made my world feel lighter, brighter, and beautifully real.<br/>
          I can‚Äôt wait to share this life with you gently, proudly, and with a lot of love.
        </p>

        <div class="btns" style="justify-content:center; margin-top:18px;">
          <button class="primary" id="celebrateReplay">Replay confetti</button>
          <button class="ghost" id="celebrateBack">Back to Summary</button>
        </div>

        <div class="note" style="margin:18px auto 0; max-width:780px; text-align:left;">
          <span class="dim">Plan:</span> life together shared, enlightened, and full of little joys.<br/>
          <span class="dim">Disposition:</span> together. <span class="ok">Always.</span>
        </div>
      </div>
    </div>
  `;
  mount.dataset.rendered = "true";

  // Wire celebration buttons
  const replay = document.getElementById("celebrateReplay");
  if (replay) replay.addEventListener("click", () => startCelebration(true));
  const back = document.getElementById("celebrateBack");
  if (back) back.addEventListener("click", () => showStep(4));
}

function startCelebration(force=false){
  if (confettiRaf) { cancelAnimationFrame(confettiRaf); confettiRaf = null; }
  if (confettiTimer) { clearTimeout(confettiTimer); confettiTimer = null; }
  // floating hearts
  const hearts = document.getElementById("floatingHearts");
  if (hearts){
    hearts.innerHTML = "";
    const icons = ["üíó","üíô","üíñ","üíï","‚ú®"];
    for (let i=0;i<16;i++){
      const s = document.createElement("span");
      s.textContent = icons[i % icons.length];
      s.style.left = Math.round(Math.random()*100) + "%";
      s.style.animationDelay = (Math.random()*3) + "s";
      s.style.animationDuration = (6 + Math.random()*4) + "s";
      s.style.fontSize = (14 + Math.random()*16) + "px";
      hearts.appendChild(s);
    }
  }

  // confetti canvas
  const canvas = document.getElementById("confettiCanvas");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  // If the canvas was created while the page was hidden, dimensions can be 0.
  // Ensure layout is ready.
  if (canvas.clientWidth === 0 || canvas.clientHeight === 0) {
    requestAnimationFrame(() => startCelebration(force));
    return;
  }

  function resize(){
    canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
    canvas.height = canvas.clientHeight * (window.devicePixelRatio || 1);
    ctx.setTransform((window.devicePixelRatio || 1),0,0,(window.devicePixelRatio || 1),0,0);
  }
  resize();
  window.addEventListener("resize", resize, { passive:true });

  const pieces = Array.from({length: 140}).map(()=>({
    x: Math.random()*canvas.clientWidth,
    y: -20 - Math.random()*canvas.clientHeight,
    w: 6 + Math.random()*6,
    h: 8 + Math.random()*10,
    vx: (-1 + Math.random()*2) * 1.2,
    vy: 2.0 + Math.random()*3.2,
    r: Math.random()*Math.PI,
    vr: (-1 + Math.random()*2)*0.08,
    a: 0.65 + Math.random()*0.35
  }));

  const t0 = performance.now();

  function draw(t){
    ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);

    // soft dreamy glow overlay
    ctx.save();
    ctx.globalAlpha = 0.10;
    ctx.fillStyle = "#2563eb";
    ctx.beginPath();
    ctx.arc(canvas.clientWidth*0.15, canvas.clientHeight*0.05, 220, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "#ec4899";
    ctx.beginPath();
    ctx.arc(canvas.clientWidth*0.85, canvas.clientHeight*0.12, 240, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    pieces.forEach(p=>{
      p.x += p.vx;
      p.y += p.vy;
      p.r += p.vr;

      // gentle drift
      p.vx += (Math.random()-0.5)*0.02;

      if (p.y > canvas.clientHeight + 30){
        p.y = -20;
        p.x = Math.random()*canvas.clientWidth;
      }

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.r);

      // DO NOT hardcode colors; use a rotation of soft tints via HSL
      const hue = (210 + (p.x / canvas.clientWidth)*90 + (t - t0)/20) % 360;
      ctx.fillStyle = `hsl(${hue}, 85%, 62%)`;

      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    });

    confettiAnimId = requestAnimationFrame(draw);
  }

  if (confettiAnimId) cancelAnimationFrame(confettiAnimId);
  confettiAnimId = requestAnimationFrame(draw);
}

function stopCelebration(){
  if (confettiAnimId) cancelAnimationFrame(confettiAnimId);
  confettiAnimId = null;
}


function showResponseBox(html){
  const box = document.getElementById("afterYes");
  box.style.display = "block";
  box.innerHTML = html;
}

document.getElementById("yesBtn").addEventListener("click", async ()=>{
  const msg =
`üíç <b>Response:</b> YES ‚Äî she said yes to marry
<b>Patient:</b> ${state.patient || "Doc"}
<b>CC:</b> ${state.cc || "‚Äî"}
<b>Time:</b> ${new Date().toLocaleString()}`;
  await sendTelegramNotification(msg);

  const y = document.getElementById("yesBtn");
  const n = document.getElementById("noBtn");
  if (y && n){
    y.disabled = true; n.disabled = true;
    y.style.opacity = 0.9; n.style.opacity = 0.6;
  }

  // Go to the celebration page
  showStep(pages.length - 1);
});

document.getElementById("noBtn").addEventListener("click", async ()=>{
  const msg =
`ü§ç <b>Response:</b> Not ready / No
<b>Patient:</b> ${state.patient || "Doc"}
<b>CC:</b> ${state.cc || "‚Äî"}
<b>Time:</b> ${new Date().toLocaleString()}`;
  await sendTelegramNotification(msg);

  showResponseBox(`
    <div class="note" style="text-align:left;">
      <b>It‚Äôs okay, ${state.patient || "Doc"}.</b><br/><br/>
      I‚Äôm sorry! I guess I‚Äôm the unlucky one to miss out on a truly wonderful companion.
      No pressure and no hard feelings. Please don‚Äôt mind me.<br/><br/>
      Thank you for being you, and I genuinely wish you a beautiful future ahead. ü§ç
    </div>
  `);

  const y = document.getElementById("yesBtn");
  const n = document.getElementById("noBtn");
  if (y && n){
    y.disabled = true; n.disabled = true;
    y.style.opacity = 0.6; n.style.opacity = 0.9;
  }
});

  // Celebration page buttons
  const replayBtn = document.getElementById("celebrateReplay");
  if (replayBtn){
    replayBtn.addEventListener("click", ()=> startCelebration());
  }
  const backBtn = document.getElementById("celebrateBack");
  if (backBtn){
    backBtn.addEventListener("click", ()=> showStep(pages.length - 2));
  }


  // Init
  showStep(0);
  openValentineOverlay();
  notifyOpened();

  const enterBtn = document.getElementById("valentineEnter");
  if (enterBtn) enterBtn.addEventListener("click", closeValentineOverlay);
  const skipBtn = document.getElementById("valentineSkip");
  if (skipBtn) skipBtn.addEventListener("click", closeValentineOverlay);
</script>
</body>
</html>
